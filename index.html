<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interaktiver Molekül-Viewer</title>
    <!-- 3Dmol.js Bibliothek für 3D-Moleküldarstellung -->
    <script src="https://3dmol.org/build/3Dmol-min.js"></script>
    <style>
        /* ===== CSS RESET UND GRUNDEINSTELLUNGEN ===== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* ===== DARK MODE FARBSCHEMA ===== */
        :root {
            --hintergrund: #0d1117;
            --sidebar-bg: #161b22;
            --akzent: #58a6ff;
            --text-primaer: #c9d1d9;
            --text-sekundaer: #8b949e;
            --border: #30363d;
            --button-bg: #21262d;
            --button-hover: #30363d;
            --rot: #f85149;
            --gruen: #3fb950;
            --orange: #e3b341;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background-color: var(--hintergrund);
            color: var(--text-primaer);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* ===== HEADER ===== */
        header {
            background-color: var(--sidebar-bg);
            padding: 12px 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            z-index: 100;
        }

        .header-titel {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        header h1 {
            font-size: 1.3rem;
            font-weight: 600;
            color: var(--text-primaer);
        }

        .badge {
            background-color: var(--akzent);
            color: var(--hintergrund);
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 600;
        }

        .badge-info {
            background-color: var(--button-bg);
            color: var(--text-sekundaer);
            border: 1px solid var(--border);
        }

        /* ===== HAUPTBEREICH ===== */
        .haupt-container {
            display: flex;
            flex: 1;
            position: relative;
            overflow: hidden;
        }

        /* ===== 3D VIEWER ===== */
        #viewer-container {
            position: absolute;
            top: 0;
            left: 0;
            right: 222px;
            bottom: 0;
            background-color: var(--hintergrund);
        }

        /* ===== SIDEBAR ===== */
        .sidebar {
            width: 222px;
            background-color: var(--sidebar-bg);
            border-left: 1px solid var(--border);
            padding: 16px;
            overflow-y: auto;
            position: absolute;
            right: 0;
            top: 0;
            bottom: 0;
            z-index: 10;
        }

        .sidebar-sektion {
            margin-bottom: 20px;
        }

        .sidebar-sektion h3 {
            font-size: 0.75rem;
            text-transform: uppercase;
            color: var(--text-sekundaer);
            margin-bottom: 10px;
            letter-spacing: 0.5px;
        }

        /* ===== MOLEKÜL AUSWAHL ===== */
        .molekuel-select {
            width: 100%;
            padding: 8px 12px;
            background-color: var(--button-bg);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-primaer);
            font-size: 0.9rem;
            cursor: pointer;
            outline: none;
        }

        .molekuel-select:hover {
            border-color: var(--akzent);
        }

        .molekuel-select:focus {
            border-color: var(--akzent);
            box-shadow: 0 0 0 2px rgba(88, 166, 255, 0.2);
        }

        /* ===== STIL BUTTONS ===== */
        .button-gruppe {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 6px;
        }

        .stil-button {
            padding: 8px 10px;
            background-color: var(--button-bg);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-primaer);
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .stil-button:hover {
            background-color: var(--button-hover);
            border-color: var(--text-sekundaer);
        }

        .stil-button.aktiv {
            background-color: var(--akzent);
            color: var(--hintergrund);
            border-color: var(--akzent);
            font-weight: 600;
        }

        /* ===== TOGGLE CHECKBOX ===== */
        .toggle-container {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 0;
        }

        .toggle-label {
            font-size: 0.85rem;
            color: var(--text-primaer);
        }

        .toggle-switch {
            position: relative;
            width: 40px;
            height: 20px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--button-bg);
            border: 1px solid var(--border);
            border-radius: 20px;
            transition: 0.3s;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 14px;
            width: 14px;
            left: 2px;
            bottom: 2px;
            background-color: var(--text-sekundaer);
            border-radius: 50%;
            transition: 0.3s;
        }

        .toggle-switch input:checked + .toggle-slider {
            background-color: var(--akzent);
            border-color: var(--akzent);
        }

        .toggle-switch input:checked + .toggle-slider:before {
            transform: translateX(20px);
            background-color: white;
        }

        /* ===== SLIDER ===== */
        .slider-container {
            margin-top: 10px;
        }

        .slider-header {
            display: flex;
            justify-content: space-between;
            font-size: 0.8rem;
            color: var(--text-sekundaer);
            margin-bottom: 6px;
        }

        .slider-wert {
            color: var(--akzent);
            font-weight: 600;
        }

        input[type="range"] {
            width: 100%;
            height: 4px;
            background: var(--button-bg);
            border-radius: 2px;
            outline: none;
            -webkit-appearance: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 14px;
            height: 14px;
            background: var(--akzent);
            border-radius: 50%;
            cursor: pointer;
        }

        input[type="range"]::-moz-range-thumb {
            width: 14px;
            height: 14px;
            background: var(--akzent);
            border-radius: 50%;
            cursor: pointer;
            border: none;
        }

        /* ===== FARBSKALA ===== */
        .farbskala {
            height: 12px;
            border-radius: 4px;
            background: linear-gradient(to right, #f85149, #ffffff, #58a6ff);
            margin-top: 8px;
        }

        .farbskala-labels {
            display: flex;
            justify-content: space-between;
            font-size: 0.65rem;
            color: var(--text-sekundaer);
            margin-top: 4px;
        }

        /* ===== MOLEKÜL INFO ===== */
        .info-grid {
            display: grid;
            gap: 8px;
        }

        .info-zeile {
            display: flex;
            justify-content: space-between;
            font-size: 0.8rem;
            padding: 4px 0;
            border-bottom: 1px solid var(--border);
        }

        .info-zeile:last-child {
            border-bottom: none;
        }

        .info-label {
            color: var(--text-sekundaer);
        }

        .info-wert {
            color: var(--text-primaer);
            font-weight: 500;
        }

        /* ===== POLARITÄTS-BADGE ===== */
        .polaritaet-badge {
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.7rem;
            font-weight: 600;
        }

        .polar {
            background-color: rgba(248, 81, 73, 0.2);
            color: var(--rot);
        }

        .unpolar {
            background-color: rgba(63, 185, 80, 0.2);
            color: var(--gruen);
        }

        /* ===== FOOTER ===== */
        footer {
            background-color: var(--sidebar-bg);
            padding: 10px 20px;
            border-top: 1px solid var(--border);
            text-align: center;
            font-size: 0.75rem;
            color: var(--text-sekundaer);
        }

        footer a {
            color: var(--akzent);
            text-decoration: none;
        }

        footer a:hover {
            text-decoration: underline;
        }

        /* ===== ELEKTROGENATIVITÄTEN LISTE ===== */
        .en-liste {
            font-size: 0.75rem;
            color: var(--text-sekundaer);
            margin-top: 8px;
            padding: 8px;
            background-color: var(--button-bg);
            border-radius: 6px;
        }

        .en-eintrag {
            display: flex;
            justify-content: space-between;
            padding: 3px 0;
        }

        .en-atom {
            color: var(--text-primaer);
            font-weight: 500;
        }

        .en-wert {
            color: var(--akzent);
        }
    </style>
</head>
<body>
    <!-- ===== HEADER ===== -->
    <header>
        <div class="header-titel">
            <h1>Interaktiver Molekül-Viewer</h1>
            <span class="badge">3D</span>
            <span class="badge badge-info">3Dmol.js</span>
        </div>
    </header>

    <!-- ===== HAUPTBEREICH ===== -->
    <div class="haupt-container">
        <!-- 3D Viewer Container -->
        <div id="viewer-container"></div>

        <!-- Sidebar mit Steuerung -->
        <aside class="sidebar">
            <!-- Molekül Auswahl -->
            <div class="sidebar-sektion">
                <h3>Molekül</h3>
                <select id="molekuel-auswahl" class="molekuel-select">
                    <option value="h2o">H₂O (Wasser)</option>
                    <option value="ch4">CH₄ (Methan)</option>
                    <option value="dcm">CH₂Cl₂ (DCM)</option>
                </select>
            </div>

            <!-- Darstellungsstil -->
            <div class="sidebar-sektion">
                <h3>Darstellung</h3>
                <div class="button-gruppe">
                    <button class="stil-button aktiv" data-stil="kugel-stab">Kugel-Stab</button>
                    <button class="stil-button" data-stil="stab">Stäbchen</button>
                    <button class="stil-button" data-stil="kugel">Kugeln</button>
                    <button class="stil-button" data-stil="draht">Drahtmodell</button>
                </div>
            </div>

            <!-- ESP Oberfläche -->
            <div class="sidebar-sektion">
                <h3>ESP-Oberfläche</h3>
                <div class="toggle-container">
                    <span class="toggle-label">Anzeigen</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="esp-toggle">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
                <div class="slider-container">
                    <div class="slider-header">
                        <span>Opazität</span>
                        <span class="slider-wert" id="esp-opazitaet-wert">0.70</span>
                    </div>
                    <input type="range" id="esp-opazitaet" min="0.05" max="1" step="0.05" value="0.70">
                </div>
                <div class="farbskala"></div>
                <div class="farbskala-labels">
                    <span>δ⁻ (Rot)</span>
                    <span>δ⁺ (Blau)</span>
                </div>
            </div>

            <!-- Elektronendichte -->
            <div class="sidebar-sektion">
                <h3>Elektronendichte</h3>
                <div class="toggle-container">
                    <span class="toggle-label">Isoflächen</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="dichte-toggle">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
            </div>

            <!-- Molekül Informationen -->
            <div class="sidebar-sektion">
                <h3>Moleküldaten</h3>
                <div class="info-grid">
                    <div class="info-zeile">
                        <span class="info-label">Formel</span>
                        <span class="info-wert" id="info-formel">H₂O</span>
                    </div>
                    <div class="info-zeile">
                        <span class="info-label">Atome</span>
                        <span class="info-wert" id="info-atome">3</span>
                    </div>
                    <div class="info-zeile">
                        <span class="info-label">Bindungen</span>
                        <span class="info-wert" id="info-bindungen">2</span>
                    </div>
                    <div class="info-zeile">
                        <span class="info-label">Geometrie</span>
                        <span class="info-wert" id="info-geometrie">gewinkelt</span>
                    </div>
                    <div class="info-zeile">
                        <span class="info-label">Bindungswinkel</span>
                        <span class="info-wert" id="info-winkel">104.5°</span>
                    </div>
                    <div class="info-zeile">
                        <span class="info-label">Bindungslänge</span>
                        <span class="info-wert" id="info-laenge">0.96 Å</span>
                    </div>
                    <div class="info-zeile">
                        <span class="info-label">ΔEN (max)</span>
                        <span class="info-wert" id="info-delta-en">1.24</span>
                    </div>
                    <div class="info-zeile">
                        <span class="info-label">Polarität</span>
                        <span class="polaritaet-badge polar" id="info-polaritaet">polar</span>
                    </div>
                </div>
                <div class="en-liste" id="en-liste">
                    <!-- Elektronegativitäten werden dynamisch eingefügt -->
                </div>
            </div>
        </aside>
    </div>

    <!-- ===== FOOTER ===== -->
    <footer>
        Visualisierung mit <a href="https://3dmol.org" target="_blank">3Dmol.js</a> | 
        Daten: Standardwerte aus Literatur (Pauling-EN, experimentelle Geometrien)
    </footer>

    <script>
        // =====================================================================
        // INTERAKTIVER MOLEKÜL-VIEWER
        // =====================================================================
        // Dieser Viewer zeigt 3D-Kugelmodelle von Molekülen mit:
        // - ESP (Elektrostatisches Potential) Oberflächen
        // - Elektronendichte-Isoflächen
        // - Verschiedene Darstellungsstile
        // =====================================================================

        // ===== MOLEKÜL-DATENBANK =====
        // Enthält alle Molekülinformationen: Strukturdaten, Eigenschaften, Partialladungen
        const molekuelDaten = {
            // ----- WASSER (H₂O) -----
            // Gewinkeltes Molekül mit 104.5° Bindungswinkel
            // Stark polar durch hohe EN-Differenz O-H
            h2o: {
                name: "Wasser",
                formel: "H₂O",
                anzahlAtome: 3,
                anzahlBindungen: 2,
                geometrie: "gewinkelt",
                bindungswinkel: "104.5°",
                bindungslaenge: "0.96 Å",
                // Atompositionen in Ångström (experimentelle Geometrie)
                atome: [
                    { element: "O", x: 0.0, y: 0.0, z: 0.0, ladung: -0.834 },
                    { element: "H", x: 0.96, y: 0.0, z: 0.0, ladung: 0.417 },
                    { element: "H", x: -0.24, y: 0.93, z: 0.0, ladung: 0.417 }
                ],
                // Elektronegativitäten nach Pauling
                elektronegativitaeten: { "O": 3.44, "H": 2.20 },
                deltaEN: 1.24,  // |3.44 - 2.20|
                polar: true,
                // RWB-Farbgrenzen für ESP-Darstellung (kalibriert für guten Kontrast)
                espMin: -0.22,
                espMax: 0.09,
                // SDF-Format String für 3Dmol.js
                sdf: `
     RDKit          3D

  3  2  0  0  0  0  0  0  0  0999 V2000
    0.0000    0.0000    0.0000 O   0  0  0  0  0  0  0  0  0  0  0  0
    0.9600    0.0000    0.0000 H   0  0  0  0  0  0  0  0  0  0  0  0
   -0.2400    0.9300    0.0000 H   0  0  0  0  0  0  0  0  0  0  0  0
  1  2  1  0
  1  3  1  0
M  END
`
            },

            // ----- METHAN (CH₄) -----
            // Perfekte Tetraeder-Geometrie (109.5°)
            // Unpolar da symmetrisch - Dipole heben sich auf
            ch4: {
                name: "Methan",
                formel: "CH₄",
                anzahlAtome: 5,
                anzahlBindungen: 4,
                geometrie: "tetraedrisch",
                bindungswinkel: "109.5°",
                bindungslaenge: "1.09 Å",
                // Tetraeder-Koordinaten berechnet aus idealem Winkel
                atome: [
                    { element: "C", x: 0.0, y: 0.0, z: 0.0, ladung: -0.266 },
                    { element: "H", x: 0.63, y: 0.63, z: 0.63, ladung: 0.0665 },
                    { element: "H", x: -0.63, y: -0.63, z: 0.63, ladung: 0.0665 },
                    { element: "H", x: -0.63, y: 0.63, z: -0.63, ladung: 0.0665 },
                    { element: "H", x: 0.63, y: -0.63, z: -0.63, ladung: 0.0665 }
                ],
                elektronegativitaeten: { "C": 2.55, "H": 2.20 },
                deltaEN: 0.35,  // |2.55 - 2.20|
                polar: false,  // Symmetrisch = unpolar trotz polarer Bindungen
                espMin: -0.08,
                espMax: 0.08,
                sdf: `
     RDKit          3D

  5  4  0  0  0  0  0  0  0  0999 V2000
    0.0000    0.0000    0.0000 C   0  0  0  0  0  0  0  0  0  0  0  0
    0.6300    0.6300    0.6300 H   0  0  0  0  0  0  0  0  0  0  0  0
   -0.6300   -0.6300    0.6300 H   0  0  0  0  0  0  0  0  0  0  0  0
   -0.6300    0.6300   -0.6300 H   0  0  0  0  0  0  0  0  0  0  0  0
    0.6300   -0.6300   -0.6300 H   0  0  0  0  0  0  0  0  0  0  0  0
  1  2  1  0
  1  3  1  0
  1  4  1  0
  1  5  1  0
M  END
`
            },

            // ----- DICHLORMETHAN (CH₂Cl₂) -----
            // Tetraedrische Geometrie um den Kohlenstoff
            // Polar da asymmetrische Ladungsverteilung (Cl vs H)
            dcm: {
                name: "Dichlormethan",
                formel: "CH₂Cl₂",
                anzahlAtome: 5,
                anzahlBindungen: 4,
                geometrie: "tetraedrisch",
                bindungswinkel: "112° / 108°",
                bindungslaenge: "C-Cl: 1.77 Å, C-H: 1.09 Å",
                atome: [
                    { element: "C", x: 0.0, y: 0.0, z: 0.0, ladung: 0.142 },
                    { element: "Cl", x: 1.77, y: 0.0, z: 0.0, ladung: -0.178 },
                    { element: "Cl", x: -0.59, y: -1.67, z: 0.0, ladung: -0.178 },
                    { element: "H", x: -0.52, y: 0.52, z: 0.89, ladung: 0.107 },
                    { element: "H", x: -0.52, y: 0.52, z: -0.89, ladung: 0.107 }
                ],
                elektronegativitaeten: { "C": 2.55, "H": 2.20, "Cl": 3.16 },
                deltaEN: 0.96,  // |3.16 - 2.20| für Cl-C Bindung
                polar: true,
                espMin: -0.15,
                espMax: 0.12,
                sdf: `
     RDKit          3D

  5  4  0  0  0  0  0  0  0  0999 V2000
    0.0000    0.0000    0.0000 C   0  0  0  0  0  0  0  0  0  0  0  0
    1.7700    0.0000    0.0000 Cl  0  0  0  0  0  0  0  0  0  0  0  0
   -0.5900   -1.6700    0.0000 Cl  0  0  0  0  0  0  0  0  0  0  0  0
   -0.5200    0.5200    0.8900 H   0  0  0  0  0  0  0  0  0  0  0  0
   -0.5200    0.5200   -0.8900 H   0  0  0  0  0  0  0  0  0  0  0  0
  1  2  1  0
  1  3  1  0
  1  4  1  0
  1  5  1  0
M  END
`
            }
        };

        // ===== GLOBALE VARIABLEN =====
        let viewer = null;              // 3Dmol Viewer Instanz
        let aktuellesMolekuel = 'h2o';  // Aktuell ausgewähltes Molekül
        let aktuellerStil = 'kugel-stab'; // Aktueller Darstellungsstil
        let espOberflaeche = null;      // Referenz auf ESP-Oberflächenobjekt
        let dichteOberflaechen = [];    // Array für Elektronendichte-Isoflächen

        // ===== VIEWER INITIALISIERUNG =====
        // Erstellt den 3Dmol.js Viewer im Container-Element
        function viewerInitialisieren() {
            const container = document.getElementById('viewer-container');
            
            // 3Dmol Viewer mit Konfiguration erstellen
            viewer = $3Dmol.createViewer(container, {
                backgroundColor: '#0d1117',  // Passend zum Dark Mode
                antialias: true              // Kantenglättung für bessere Darstellung
            });

            // Erstes Molekül laden
            molekuelLaden(aktuellesMolekuel);
        }

        // ===== MOLEKÜL LADEN =====
        // Lädt ein Molekül aus der Datenbank und zeigt es an
        // Parameter: molekuelId - Schlüssel in molekuelDaten ('h2o', 'ch4', 'dcm')
        function molekuelLaden(molekuelId) {
            const daten = molekuelDaten[molekuelId];
            aktuellesMolekuel = molekuelId;

            // Viewer komplett zurücksetzen für sauberen Neuaufbau
            viewer.removeAllModels();
            viewer.removeAllSurfaces();
            espOberflaeche = null;
            dichteOberflaechen = [];

            // Molekül aus SDF-String laden
            // SDF (Structure Data File) ist ein Standardformat für Molekülstrukturen
            viewer.addModel(daten.sdf, "sdf");

            // Darstellungsstil anwenden
            stilAnwenden(aktuellerStil);

            // Ansicht auf Molekül zentrieren mit Animation
            viewer.zoomTo();
            viewer.render();

            // UI-Informationen aktualisieren
            infoAktualisieren(daten);

            // Falls ESP aktiviert ist, Oberfläche neu berechnen
            if (document.getElementById('esp-toggle').checked) {
                espOberflaeche = espBerechnenUndAnzeigen();
            }

            // Falls Dichte aktiviert ist, Isoflächen neu berechnen
            if (document.getElementById('dichte-toggle').checked) {
                dichteIsoflaechen();
            }
        }

        // ===== DARSTELLUNGSSTIL ANWENDEN =====
        // Ändert die visuelle Darstellung des Moleküls
        // Parameter: stil - einer von: 'kugel-stab', 'stab', 'kugel', 'draht'
        function stilAnwenden(stil) {
            aktuellerStil = stil;
            
            // Alle Stile zurücksetzen
            viewer.setStyle({}, {});

            // Jmol-Farbschema: Standardfarben für Elemente
            // O=rot, H=weiß, C=grau, N=blau, Cl=grün, etc.
            switch(stil) {
                case 'kugel-stab':
                    // Kombination aus Kugeln (Atome) und Stäben (Bindungen)
                    // Beste Darstellung für Molekülgeometrie
                    viewer.setStyle({}, {
                        stick: { radius: 0.15, colorscheme: 'Jmol' },
                        sphere: { scale: 0.35, colorscheme: 'Jmol' }
                    });
                    break;
                case 'stab':
                    // Nur Stäbchen, zeigt Bindungen deutlich
                    viewer.setStyle({}, {
                        stick: { radius: 0.18, colorscheme: 'Jmol' }
                    });
                    break;
                case 'kugel':
                    // Nur Kugeln (Kalottenmodell-ähnlich)
                    // Zeigt relative Atomgrößen
                    viewer.setStyle({}, {
                        sphere: { scale: 0.5, colorscheme: 'Jmol' }
                    });
                    break;
                case 'draht':
                    // Minimale Darstellung als Drahtmodell
                    viewer.setStyle({}, {
                        line: { linewidth: 3, colorscheme: 'Jmol' }
                    });
                    break;
            }

            viewer.render();

            // Button-Hervorhebung aktualisieren
            document.querySelectorAll('.stil-button').forEach(btn => {
                btn.classList.remove('aktiv');
                if (btn.dataset.stil === stil) {
                    btn.classList.add('aktiv');
                }
            });
        }

        // ===== ESP (ELEKTROSTATISCHES POTENTIAL) BERECHNUNG =====
        // Berechnet das elektrostatische Potential auf einem 3D-Gitter
        // und zeigt es als VDW-Oberfläche mit RWB-Farbgradient an
        // 
        // Formel: ESP(r) = Σᵢ qᵢ · exp(−α · |r − rᵢ|²)
        // - qᵢ = Partialladung des Atoms i
        // - rᵢ = Position des Atoms i
        // - α = 0.15 Bohr⁻² (Dämpfungsfaktor für Gauß-Verschmierung)
        //
        // Der Faktor α = 0.15 sorgt für eine weiche Verschmierung der
        // Punktladungen, was physikalisch sinnvoller ist als harte Coulomb-Potentiale
        function espBerechnenUndAnzeigen() {
            const daten = molekuelDaten[aktuellesMolekuel];
            const atome = daten.atome;

            // Gitterparameter für das Volumen
            // Größeres Gitter = genauer aber langsamer
            const nx = 22, ny = 22, nz = 16;  // Gitterpunkte pro Dimension
            const xMin = -4.5, xMax = 4.5;    // Ausdehnung in Ångström
            const yMin = -4.5, yMax = 4.5;
            const zMin = -3.0, zMax = 3.0;

            // Schrittweite berechnen
            const dx = (xMax - xMin) / (nx - 1);
            const dy = (yMax - yMin) / (ny - 1);
            const dz = (zMax - zMin) / (nz - 1);

            // 1D-Array für Volumendaten erstellen
            // 3Dmol erwartet die Daten in dieser Reihenfolge: z → y → x (schnellster Index zuerst)
            const volumenDaten = new Float32Array(nx * ny * nz);
            
            // Dämpfungsfaktor für Gauß-Funktion
            // α = 0.15 gibt eine weiche Verschmierung über ca. 2-3 Å
            const alpha = 0.15;

            // ESP für jeden Gitterpunkt berechnen
            let index = 0;
            for (let iz = 0; iz < nz; iz++) {
                for (let iy = 0; iy < ny; iy++) {
                    for (let ix = 0; ix < nx; ix++) {
                        // Aktuelle Gitterposition
                        const x = xMin + ix * dx;
                        const y = yMin + iy * dy;
                        const z = zMin + iz * dz;

                        // ESP als Summe der Beiträge aller Atome
                        let esp = 0;
                        for (const atom of atome) {
                            // Abstand zum Atom berechnen
                            const rx = x - atom.x;
                            const ry = y - atom.y;
                            const rz = z - atom.z;
                            const r2 = rx * rx + ry * ry + rz * rz;

                            // Gauß-verschmierter Ladungsbeitrag
                            esp += atom.ladung * Math.exp(-alpha * r2);
                        }

                        volumenDaten[index++] = esp;
                    }
                }
            }

            // Volumendaten-Objekt für 3Dmol erstellen
            // Dieses Format entspricht einem vereinfachten Gaussian Cube
            const volData = new $3Dmol.VolumeData(volumenDaten, {
                unit: {
                    // Einheitszelle des Gitters
                    x: { x: dx * nx, y: 0, z: 0 },
                    y: { x: 0, y: dy * ny, z: 0 },
                    z: { x: 0, y: 0, z: dz * nz }
                },
                origin: { x: xMin, y: yMin, z: zMin },
                size: { x: nx, y: ny, z: nz }
            });

            // Aktuellen Opazitätswert aus Slider holen
            const opazitaet = parseFloat(document.getElementById('esp-opazitaet').value);

            // VDW-Oberfläche mit ESP-Farbkodierung hinzufügen
            // RWB = Red-White-Blue Gradient
            // Rot = negatives Potential (elektronenreich, δ⁻)
            // Weiß = neutral
            // Blau = positives Potential (elektroarm, δ⁺)
            viewer.addSurface($3Dmol.SurfaceType.VDW, {
                opacity: opazitaet,
                voldata: volData,
                volscheme: new $3Dmol.Gradient.RWB(daten.espMin, daten.espMax)
            });

            viewer.render();
        }

        // ===== ESP OBERFLÄCHE AKTUALISIEREN =====
        // Entfernt alte Oberfläche und erstellt neue (für Opazitätsänderungen)
        function espAktualisieren() {
            if (!document.getElementById('esp-toggle').checked) return;
            
            // Alle Oberflächen entfernen und ESP neu berechnen
            viewer.removeAllSurfaces();
            espBerechnenUndAnzeigen();
            
            // Falls Dichte auch aktiv ist, auch diese neu erstellen
            if (document.getElementById('dichte-toggle').checked) {
                dichteIsoflaechen();
            }
        }

        // ===== ELEKTRONENDICHTE ISOFLÄCHEN =====
        // Berechnet Elektronendichte und zeigt zwei Isoflächen:
        // - Äußere Hülle (η = 0.10): zeigt Molekülumriss
        // - Innerer Kern (η = 0.55): zeigt Kernregionen
        //
        // Formel: ρ(r) = Σᵢ Zᵢ · exp(−αᵢ · |r − rᵢ|²)
        // - Zᵢ = Ordnungszahl (verhält sich wie Elektronenzahl)
        // - αᵢ = Elementspezifischer Exponent (größer für schwerere Atome)
        function dichteIsoflaechen() {
            const daten = molekuelDaten[aktuellesMolekuel];
            const atome = daten.atome;

            // Element-spezifische Parameter
            // Ordnungszahlen und Exponenten für Gauß-Funktionen
            const elementDaten = {
                "H":  { z: 1,  alpha: 0.45 },  // Wasserstoff: klein und diffus
                "C":  { z: 6,  alpha: 0.60 },  // Kohlenstoff: mittlere Größe
                "O":  { z: 8,  alpha: 0.80 },  // Sauerstoff: kompakter
                "Cl": { z: 17, alpha: 0.70 }   // Chlor: groß aber noch kompakt
            };

            // Gitterparameter (identisch zu ESP für Konsistenz)
            const nx = 22, ny = 22, nz = 16;
            const xMin = -4.5, xMax = 4.5;
            const yMin = -4.5, yMax = 4.5;
            const zMin = -3.0, zMax = 3.0;

            const dx = (xMax - xMin) / (nx - 1);
            const dy = (yMax - yMin) / (ny - 1);
            const dz = (zMax - zMin) / (nz - 1);

            const volumenDaten = new Float32Array(nx * ny * nz);

            // Elektronendichte für jeden Gitterpunkt berechnen
            let index = 0;
            for (let iz = 0; iz < nz; iz++) {
                for (let iy = 0; iy < ny; iy++) {
                    for (let ix = 0; ix < nx; ix++) {
                        const x = xMin + ix * dx;
                        const y = yMin + iy * dy;
                        const z = zMin + iz * dz;

                        let dichte = 0;
                        for (const atom of atome) {
                            const elemDaten = elementDaten[atom.element];
                            if (!elemDaten) continue;

                            const rx = x - atom.x;
                            const ry = y - atom.y;
                            const rz = z - atom.z;
                            const r2 = rx * rx + ry * ry + rz * rz;

                            // Beitrag proportional zur Ordnungszahl
                            dichte += elemDaten.z * Math.exp(-elemDaten.alpha * r2);
                        }

                        volumenDaten[index++] = dichte;
                    }
                }
            }

            // Volumendaten-Objekt erstellen
            const volData = new $3Dmol.VolumeData(volumenDaten, {
                unit: {
                    x: { x: dx * nx, y: 0, z: 0 },
                    y: { x: 0, y: dy * ny, z: 0 },
                    z: { x: 0, y: 0, z: dz * nz }
                },
                origin: { x: xMin, y: yMin, z: zMin },
                size: { x: nx, y: ny, z: nz }
            });

            // Äußere Isofläche (η = 0.10)
            // Zeigt die äußere Elektronenhülle als transparente blaue Schale
            viewer.addIsosurface(volData, {
                isoval: 0.10,
                color: '#58a6ff',  // Akzentfarbe Blau
                opacity: 0.18,
                smoothness: 1
            });

            // Innere Isofläche (η = 0.55)
            // Zeigt die dichtere Kernregion als orange-amber Kern
            viewer.addIsosurface(volData, {
                isoval: 0.55,
                color: '#e3b341',  // Amber/Orange
                opacity: 0.45,
                smoothness: 1
            });

            viewer.render();
        }

        // ===== MOLEKÜL-INFO AKTUALISIEREN =====
        // Aktualisiert alle Informationsfelder in der Sidebar
        function infoAktualisieren(daten) {
            document.getElementById('info-formel').textContent = daten.formel;
            document.getElementById('info-atome').textContent = daten.anzahlAtome;
            document.getElementById('info-bindungen').textContent = daten.anzahlBindungen;
            document.getElementById('info-geometrie').textContent = daten.geometrie;
            document.getElementById('info-winkel').textContent = daten.bindungswinkel;
            document.getElementById('info-laenge').textContent = daten.bindungslaenge;
            document.getElementById('info-delta-en').textContent = daten.deltaEN.toFixed(2);

            // Polaritäts-Badge
            const polarBadge = document.getElementById('info-polaritaet');
            if (daten.polar) {
                polarBadge.textContent = 'polar';
                polarBadge.className = 'polaritaet-badge polar';
            } else {
                polarBadge.textContent = 'unpolar';
                polarBadge.className = 'polaritaet-badge unpolar';
            }

            // Elektronegativitäten-Liste aufbauen
            const enListe = document.getElementById('en-liste');
            enListe.innerHTML = '<strong style="color: var(--text-primaer);">Elektronegativitäten:</strong>';
            
            for (const [element, en] of Object.entries(daten.elektronegativitaeten)) {
                const eintrag = document.createElement('div');
                eintrag.className = 'en-eintrag';
                eintrag.innerHTML = `
                    <span class="en-atom">${element}</span>
                    <span class="en-wert">${en.toFixed(2)}</span>
                `;
                enListe.appendChild(eintrag);
            }
        }

        // ===== EVENT LISTENER EINRICHTEN =====
        // Verbindet alle UI-Elemente mit ihren Handler-Funktionen
        function eventListenerEinrichten() {
            // Molekül-Auswahl Dropdown
            document.getElementById('molekuel-auswahl').addEventListener('change', (e) => {
                molekuelLaden(e.target.value);
            });

            // Stil-Buttons
            document.querySelectorAll('.stil-button').forEach(button => {
                button.addEventListener('click', () => {
                    stilAnwenden(button.dataset.stil);
                });
            });

            // ESP-Toggle
            document.getElementById('esp-toggle').addEventListener('change', (e) => {
                if (e.target.checked) {
                    espBerechnenUndAnzeigen();
                } else {
                    // Nur ESP entfernen, Dichte-Isoflächen beibehalten falls aktiv
                    viewer.removeAllSurfaces();
                    if (document.getElementById('dichte-toggle').checked) {
                        dichteIsoflaechen();
                    }
                }
            });

            // ESP-Opazitäts-Slider
            document.getElementById('esp-opazitaet').addEventListener('input', (e) => {
                // Wert in UI aktualisieren
                document.getElementById('esp-opazitaet-wert').textContent = 
                    parseFloat(e.target.value).toFixed(2);
                
                // Oberfläche mit neuem Wert neu erstellen
                espAktualisieren();
            });

            // Dichte-Toggle
            document.getElementById('dichte-toggle').addEventListener('change', (e) => {
                // Alle Oberflächen entfernen und relevante neu aufbauen
                viewer.removeAllSurfaces();
                
                if (document.getElementById('esp-toggle').checked) {
                    espBerechnenUndAnzeigen();
                }
                
                if (e.target.checked) {
                    dichteIsoflaechen();
                }
            });
        }

        // ===== INITIALISIERUNG BEI SEITENLADUNG =====
        // Startet den Viewer wenn das DOM bereit ist
        document.addEventListener('DOMContentLoaded', () => {
            viewerInitialisieren();
            eventListenerEinrichten();
        });
    </script>
</body>
</html>